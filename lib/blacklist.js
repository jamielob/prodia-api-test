// Comprehensive replacement map for copyrighted terms
// Maps copyrighted terms to safe, generic alternatives
export const REPLACEMENT_MAP = {
  // Text and typography - remove these entirely
  'text': '', 'logo': '', 'brand': '', 'label': '', 'sign': '', 'poster': '', 'banner': '',
  'typography': '', 'lettering': '', 'words': '', 'writing': '', 'letters': '', 'font': '',
  
  // Marvel
  'spiderman': 'spider based superhero', 'spider-man': 'spider based superhero', 'spider man': 'spider based superhero',
  'ironman': 'armored superhero', 'iron-man': 'armored superhero', 'iron man': 'armored superhero',
  'captainamerica': 'patriotic shield hero', 'captain america': 'patriotic shield hero',
  'thor': 'hammer wielding hero', 'hulk': 'green giant hero',
  'blackwidow': 'spy hero', 'black widow': 'spy hero',
  'avengers': 'superhero team', 'thanos': 'cosmic villain',
  'blackpanther': 'feline hero', 'black panther': 'feline hero',
  'doctorstrange': 'mystical sorcerer', 'doctor strange': 'mystical sorcerer',
  'wolverine': 'clawed mutant', 'deadpool': 'red suited antihero',
  'x-men': 'mutant heroes', 'xmen': 'mutant heroes',
  
  // DC
  'superman': 'flying alien hero', 'batman': 'caped vigilante',
  'wonderwoman': 'amazonian warrior', 'wonder woman': 'amazonian warrior',
  'joker': 'laughing villain', 'harleyquinn': 'chaotic villain', 'harley quinn': 'chaotic villain',
  
  // Star Wars
  'starwars': 'space saga', 'star wars': 'space saga',
  'jedi': 'space knight', 'sith': 'dark space warrior',
  'vader': 'masked villain', 'darth vader': 'masked villain',
  'yoda': 'wise alien mentor', 'chewbacca': 'furry alien',
  'mandalorian': 'armored bounty hunter', 'grogu': 'small alien child',
  'babyyoda': 'small alien child', 'baby yoda': 'small alien child',
  
  // Harry Potter
  'harrypotter': 'young wizard with scarf', 'harry potter': 'young wizard with scarf',
  'hermione': 'clever witch student', 
  'ronweasley': 'red haired wizard', 'ron weasley': 'red haired wizard',
  'dumbledore': 'wise headmaster', 'voldemort': 'dark wizard',
  'hogwarts': 'magic school', 'quidditch': 'flying sport',
  
  // Lord of the Rings
  'frodo': 'ring bearer', 'gandalf': 'wise wizard',
  'aragorn': 'ranger king', 'legolas': 'elf archer',
  'gollum': 'corrupted creature', 'sauron': 'dark lord',
  'middleearth': 'fantasy realm', 'middle earth': 'fantasy realm',
  
  // Disney
  'mickeymouse': 'cartoon mouse', 'mickey mouse': 'cartoon mouse',
  'minniemouse': 'cartoon mouse', 'minnie mouse': 'cartoon mouse',
  'donaldduck': 'cartoon duck', 'donald duck': 'cartoon duck',
  'elsa': 'ice princess', 'frozen': 'ice kingdom',
  'simba': 'lion cub', 'lionking': 'lion royalty', 'lion king': 'lion royalty',
  'ariel': 'mermaid princess', 'littlemermaid': 'ocean princess', 'little mermaid': 'ocean princess',
  
  // Pokemon
  'pokemon': 'creature collection', 'pikachu': 'electric mouse creature',
  'charizard': 'fire dragon creature',
  
  // Nintendo
  'mario': 'plumber hero', 'luigi': 'green plumber',
  'zelda': 'fantasy princess', 'link': 'sword hero',
  
  // Sonic
  'sonic': 'fast blue hedgehog', 'tails': 'flying fox',
  
  // Anime
  'goku': 'martial artist hero', 'dragonball': 'martial arts saga', 'dragon ball': 'martial arts saga',
  'naruto': 'ninja hero', 'luffy': 'pirate hero', 'onepiece': 'pirate adventure', 'one piece': 'pirate adventure',
  
  // Game of Thrones
  'gameofthrones': 'medieval fantasy', 'game of thrones': 'medieval fantasy',
  'jonsnow': 'northern warrior', 'jon snow': 'northern warrior',
  'daenerys': 'dragon queen', 'khaleesi': 'dragon queen',
  
  // Movies
  'transformers': 'robots in disguise', 'optimusprime': 'heroic robot', 'optimus prime': 'heroic robot',
  'jurassicpark': 'dinosaur park', 'jurassic park': 'dinosaur park',
  'indianajones': 'adventuring archaeologist', 'indiana jones': 'adventuring archaeologist',
  'terminator': 'cyborg warrior', 'thematrix': 'virtual reality', 'the matrix': 'virtual reality',
  'ghostbusters': 'paranormal investigators',
  
  // Video Games
  'minecraft': 'block building game', 'fortnite': 'battle game',
  'callofduty': 'military shooter', 'call of duty': 'military shooter',
  'masterchief': 'armored soldier', 'master chief': 'armored soldier',
  
  // TV Shows
  'breakingbad': 'crime drama', 'breaking bad': 'crime drama',
  'strangerthings': 'supernatural mystery', 'stranger things': 'supernatural mystery',
  'thesimpsons': 'animated family', 'the simpsons': 'animated family',
  'spongebob': 'underwater sponge', 'spongebobsquarepants': 'underwater sponge', 'spongebob squarepants': 'underwater sponge',
  
  // Car manufacturers
  'toyota': 'car brand', 'ford': 'car brand', 'chevrolet': 'car brand', 'chevy': 'car brand',
  'honda': 'car brand', 'nissan': 'car brand', 'hyundai': 'car brand',
  'mercedes': 'luxury car', 'bmw': 'luxury car', 'audi': 'luxury car',
  'volkswagen': 'car brand', 'porsche': 'sports car', 'ferrari': 'sports car',
  'lamborghini': 'exotic car', 'tesla': 'electric car', 'mazda': 'car brand',
  'subaru': 'car brand', 'lexus': 'luxury car', 'cadillac': 'luxury car',
  'dodge': 'car brand', 'jeep': 'suv brand', 'ram': 'truck brand',
  'volvo': 'car brand', 'jaguar': 'luxury car', 'bentley': 'luxury car',
  'rollsroyce': 'luxury car', 'maserati': 'luxury car', 'bugatti': 'hypercar',
  'mclaren': 'supercar', 'lotus': 'sports car',
  
  // Fashion brands
  'nike': 'sportswear', 'adidas': 'athletic wear', 'puma': 'athletic wear',
  'gucci': 'luxury fashion', 'prada': 'luxury fashion', 'chanel': 'luxury fashion',
  'dior': 'luxury fashion', 'versace': 'luxury fashion', 'armani': 'luxury fashion',
  'burberry': 'luxury fashion', 'louisvuitton': 'luxury fashion', 'louis vuitton': 'luxury fashion',
  
  // Food and beverage
  'cocacola': 'cola drink', 'coca cola': 'cola drink', 'coke': 'cola drink',
  'pepsi': 'cola drink', 'sprite': 'soda', 'fanta': 'soda',
  'redbull': 'energy drink', 'red bull': 'energy drink', 'monster': 'energy drink',
  'mcdonalds': 'fast food', 'burgerking': 'fast food', 'burger king': 'fast food',
  'starbucks': 'coffee shop', 'subway': 'sandwich shop',
  'kfc': 'fried chicken restaurant', 'pizzahut': 'pizza restaurant', 'pizza hut': 'pizza restaurant',
  
  // Tech brands
  'microsoft': 'tech company', 'samsung': 'tech company', 'intel': 'processor brand',
  'nvidia': 'graphics card', 'playstation': 'game console', 'xbox': 'game console',
  'nintendo': 'game console',
  
  // Studios and entertainment
  'disney': 'entertainment', 'pixar': 'animation studio', 'marvel': 'superhero franchise',
  'dreamworks': 'animation studio', 'warner': 'studio', 'universal': 'studio',
};

/**
 * Replaces copyrighted terms in a prompt with safe alternatives using Groq AI
 * @param {string} prompt - The input prompt
 * @returns {Promise<string>} - The filtered prompt with replacements
 */
export async function filterPrompt(prompt) {
  if (!prompt) return '';
  
  console.log('[Groq] Filtering prompt:', prompt);
  
  try {
    const groqApiKey = process.env.GROQ_API_KEY;
    if (!groqApiKey) {
      console.warn('[Groq] GROQ_API_KEY not found, returning original prompt');
      return prompt;
    }

    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${groqApiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'llama-3.3-70b-versatile',
        messages: [
          {
            role: 'user',
            content: `1. Remove words related to text/logos: text, logo, brand, lettering, typography, words, numbers, letters, font, label, sign
2. Replace brand/character names with "abstract [description]": BMW→abstract luxury car, Star Wars→abstract space saga
3. Keep fashion styles unchanged: grunge, academia, chic, vintage

TO replace:
- "with text" → "" (removed)
- "BMW logo" → "abstract luxury car"
- "Star Wars" → "abstract space saga"

NOT to replace:
- "dark academia" → "dark academia"
- "grunge style" → "grunge style"

Text: ${prompt}
Filtered:`
          }
        ],
        temperature: 0.3,
        max_tokens: 500,
      }),
    });

    if (!response.ok) {
      console.error('Groq API error:', response.status);
      return prompt;
    }

    const data = await response.json();
    let filtered = data.choices?.[0]?.message?.content?.trim();
    console.log('[Groq] Raw AI response:', filtered);
    
    // Remove explanation text (e.g., "Since there are no...", "the filtered text remains")
    // Also handle "Filtered:" prefix from the AI response
    if (filtered && /^(Filtered|filtered):/i.test(filtered)) {
      filtered = filtered.replace(/^(Filtered|filtered):\s*/i, '').trim();
      console.log('[Groq] Removed "Filtered:" prefix:', filtered);
    }
    
    if (filtered && (filtered.includes('Since ') || filtered.includes('remains') || filtered.includes('given text'))) {
      // Extract text after the last colon if present (e.g., "explanation: actual text")
      if (filtered.includes(':')) {
        const lastColonIndex = filtered.lastIndexOf(':');
        const afterColon = filtered.substring(lastColonIndex + 1).trim();
        if (afterColon) {
          filtered = afterColon;
          console.log('[Groq] Extracted text after colon:', filtered);
        }
      } else {
        // Try to extract just the filtered text before the explanation
        const parts = filtered.split(/Since |As there|There are no|the filtered text/);
        if (parts[0].trim()) {
          filtered = parts[0].trim();
          console.log('[Groq] Removed explanation, extracted:', filtered);
        }
      }
    }
    
    // Remove trailing period if the original prompt didn't have one
    if (filtered && !prompt.endsWith('.') && filtered.endsWith('.')) {
      console.log('[Groq] Removing trailing period');
      filtered = filtered.slice(0, -1);
    }
    
    // Additional cleanup - remove text-related words
    const textWords = ['\\btext\\b', '\\blogo\\b', '\\bbrand\\b', '\\blettering\\b', '\\btypography\\b', '\\bwords\\b', '\\bnumbers\\b', '\\bletters\\b', '\\bfont\\b', '\\blabel\\b', '\\bsign\\b'];
    textWords.forEach(word => {
      const regex = new RegExp(word, 'gi');
      filtered = filtered.replace(regex, '').trim();
    });
    
    // Clean up multiple spaces
    filtered = filtered.replace(/\s+/g, ' ').trim();
    
    console.log('[Groq] Final filtered result:', filtered);
    return filtered || prompt;
    if (filtered && filtered.toLowerCase() === prompt.toLowerCase()) {
      return prompt;
    }
    
    return filtered || prompt;
  } catch (error) {
    console.error('Error filtering prompt with AI:', error);
    return prompt;
  }
}
